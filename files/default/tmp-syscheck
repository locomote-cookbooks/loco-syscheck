#!/usr/bin/env syscheck

check_system

check_failed_emails() {
  MAIL_LOGFILE=${MAIL_LOGFILE:-/var/log/maillog}
  local emails_sent=$(sudo grep status=sent $MAIL_LOGFILE | sed 's/.* to=<//g' | sed 's/>,.*//g' | sort -u)
  local emails_failed=$(sudo grep status= $MAIL_LOGFILE | grep -v sent | sed 's/.* to=<//g' | sed 's/>,.*//g' | grep -v root | grep -v localhost | grep -v locomotetmp)

  local number_of_sent_emails=$(  [  "$emails_sent"   ] && (echo "$emails_sent" | wc -l | tr -d ' ') || echo 0)
  local number_of_failed_emails=$([  "$emails_failed" ] && (echo "$emails_failed" | wc -l | tr -d ' ') || echo 0)

  run echo "$number_of_sent_emails email(s) sent to : $(    echo "$emails_sent"     | sort -u | xargs)"
  run echo "$number_of_failed_emails email(s) failed to send to : $(echo "$emails_failed" | sort -u | xargs)"

  assert equal $number_of_failed_emails 0
}

not_on_systest() {
  [ $(hostname) != "tmp-systest" ]
}

describe 'unicorn'
  its_process_count 'unicorn_rails master' ${UNICORN_MASTER_PROCESS_COUNT:=2}
  its_process_count 'unicorn_rails worker' ${UNICORN_WORKER_PROCESS_COUNT:=8}
end_describe

describe 'nginx'
  its_process_count 'nginx: master process' ${NGINX_MASTER_PROCESS_COUNT:=1}
  its_process_count 'nginx: worker process' ${NGINX_WORKER_PROCESS_COUNT:=$(cmd_for number_of_cores)}
end_describe

describe 'resque'
  its_process_count 'resque' ${RESQUE_PROCESS_COUNT:=2}
end_describe

describe 'postfix'
  its_process_count 'postfix/master' ${POSTFIX_PROCESS_COUNT:=1}

  if not_on_systest; then
    it "should have the correct hostname in the (chef generated) postfix config file"
      myhostname=`grep ^myhostname /etc/postfix/main.cf | sed 's/^myhostname = //'`
      fqdn=`hostname --fqdn`
      run echo "=> myhostname: $myhostname (fqdn: $fqdn)"
      assert equal $myhostname $fqdn

    it 'should not have any failed emails'
      check_failed_emails
  fi

end_describe
